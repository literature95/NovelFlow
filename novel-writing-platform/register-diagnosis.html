<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ³¨å†Œé—®é¢˜è¯Šæ–­å·¥å…·</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 20px auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #0056b3; }
        button:disabled { background: #6c757d; cursor: not-allowed; }
        
        pre {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            font-size: 12px;
            border: 1px solid #e9ecef;
        }
        
        .input-group {
            margin: 10px 0;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }
        input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            box-sizing: border-box;
        }
        
        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        .step {
            display: flex;
            align-items: center;
            margin: 10px 0;
        }
        .step-number {
            background: #007bff;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            font-weight: bold;
        }
        .step.completed .step-number { background: #28a745; }
        .step.error .step-number { background: #dc3545; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” å°è¯´åˆ›ä½œå¹³å° - æ³¨å†Œé—®é¢˜è¯Šæ–­å·¥å…·</h1>
        <p>æ­¤å·¥å…·å¸®åŠ©è¯Šæ–­æ³¨å†ŒåŠŸèƒ½çš„å…·ä½“é—®é¢˜ã€‚è¯·æŒ‰é¡ºåºæ‰§è¡Œä»¥ä¸‹æµ‹è¯•æ­¥éª¤ã€‚</p>
        
        <!-- ç³»ç»ŸçŠ¶æ€æ£€æŸ¥ -->
        <div class="test-section">
            <h3>ğŸ“Š ç³»ç»ŸçŠ¶æ€æ£€æŸ¥</h3>
            <button onclick="checkSystemStatus()">æ£€æŸ¥ç³»ç»ŸçŠ¶æ€</button>
            <div id="systemStatus"></div>
        </div>
        
        <!-- æ³¨å†ŒAPIæµ‹è¯• -->
        <div class="test-section">
            <h3>ğŸ§ª æ³¨å†ŒAPIæµ‹è¯•</h3>
            <div class="grid">
                <div>
                    <button onclick="testNormalRegister()">æµ‹è¯•æ­£å¸¸æ³¨å†Œ</button>
                    <button onclick="testErrorCases()">æµ‹è¯•é”™è¯¯åœºæ™¯</button>
                </div>
                <div>
                    <button onclick="testDuplicateEmail()">æµ‹è¯•é‡å¤é‚®ç®±</button>
                    <button onclick="testTokenGeneration()">æµ‹è¯•Tokenç”Ÿæˆ</button>
                </div>
            </div>
            <div id="apiTestResults"></div>
        </div>
        
        <!-- å‰ç«¯æ¨¡æ‹Ÿæµ‹è¯• -->
        <div class="test-section">
            <h3>ğŸŒ å‰ç«¯æ¨¡æ‹Ÿæµ‹è¯•</h3>
            <div class="input-group">
                <label>é‚®ç®±:</label>
                <input type="email" id="testEmail" placeholder="è¯·è¾“å…¥æµ‹è¯•é‚®ç®±" value="frontend@example.com">
            </div>
            <div class="input-group">
                <label>ç”¨æˆ·å:</label>
                <input type="text" id="testUsername" placeholder="è¯·è¾“å…¥ç”¨æˆ·å" value="frontendtest">
            </div>
            <div class="input-group">
                <label>å¯†ç :</label>
                <input type="password" id="testPassword" placeholder="è¯·è¾“å…¥å¯†ç " value="password123">
            </div>
            <button onclick="simulateFrontendRegister()">æ¨¡æ‹Ÿå‰ç«¯æ³¨å†Œ</button>
            <div id="frontendTestResults"></div>
        </div>
        
        <!-- è¯Šæ–­æ­¥éª¤ -->
        <div class="test-section">
            <h3>ğŸ”§ å®Œæ•´è¯Šæ–­æµç¨‹</h3>
            <div class="step" id="step1">
                <div class="step-number">1</div>
                <div>æ£€æŸ¥ç³»ç»Ÿé…ç½®å’Œç¯å¢ƒå˜é‡</div>
            </div>
            <div class="step" id="step2">
                <div class="step-number">2</div>
                <div>æµ‹è¯•æ•°æ®åº“è¿æ¥</div>
            </div>
            <div class="step" id="step3">
                <div class="step-number">3</div>
                <div>éªŒè¯JWTé…ç½®</div>
            </div>
            <div class="step" id="step4">
                <div class="step-number">4</div>
                <div>æµ‹è¯•æ³¨å†ŒAPIåŠŸèƒ½</div>
            </div>
            <div class="step" id="step5">
                <div class="step-number">5</div>
                <div>æ¨¡æ‹Ÿå‰ç«¯æ³¨å†Œæµç¨‹</div>
            </div>
            <button onclick="runFullDiagnosis()">ğŸš€ è¿è¡Œå®Œæ•´è¯Šæ–­</button>
            <div id="diagnosisResults"></div>
        </div>
        
        <!-- è§£å†³æ–¹æ¡ˆ -->
        <div class="test-section">
            <h3>ğŸ’¡ å¸¸è§é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆ</h3>
            <div id="solutions">
                <div class="info">
                    <strong>å¦‚æœæ³¨å†Œå¤±è´¥ï¼Œè¯·æ£€æŸ¥ä»¥ä¸‹å¸¸è§é—®é¢˜ï¼š</strong>
                    <ul style="margin: 10px 0; padding-left: 20px;">
                        <li>ç½‘ç»œè¿æ¥é—®é¢˜ - ç¡®ä¿å¯ä»¥è®¿é—®æœåŠ¡å™¨</li>
                        <li>é‚®ç®±æ ¼å¼é”™è¯¯ - ä½¿ç”¨æœ‰æ•ˆçš„é‚®ç®±åœ°å€</li>
                        <li>å¯†ç å¤ªçŸ­ - å¯†ç è‡³å°‘éœ€è¦6ä½å­—ç¬¦</li>
                        <li>ç”¨æˆ·å·²å­˜åœ¨ - é‚®ç®±æˆ–ç”¨æˆ·åå·²è¢«æ³¨å†Œ</li>
                        <li>æµè§ˆå™¨JavaScripté”™è¯¯ - æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <script>
        // æ£€æŸ¥ç³»ç»ŸçŠ¶æ€
        async function checkSystemStatus() {
            const statusDiv = document.getElementById('systemStatus');
            statusDiv.innerHTML = '<div class="info">ğŸ”„ æ­£åœ¨æ£€æŸ¥ç³»ç»ŸçŠ¶æ€...</div>';
            
            try {
                const response = await fetch('/api/debug');
                const data = await response.json();
                
                if (data.success) {
                    let html = '<div class="success">âœ… ç³»ç»ŸçŠ¶æ€æ­£å¸¸</div>';
                    html += '<pre>' + JSON.stringify(data, null, 2) + '</pre>';
                    statusDiv.innerHTML = html;
                    updateStepStatus('step1', 'completed');
                } else {
                    statusDiv.innerHTML = `<div class="error">âŒ ç³»ç»ŸçŠ¶æ€å¼‚å¸¸: ${data.error}</div>`;
                    updateStepStatus('step1', 'error');
                }
            } catch (error) {
                statusDiv.innerHTML = `<div class="error">âŒ æ— æ³•æ£€æŸ¥ç³»ç»ŸçŠ¶æ€: ${error.message}</div>`;
                updateStepStatus('step1', 'error');
            }
        }
        
        // æµ‹è¯•æ­£å¸¸æ³¨å†Œ
        async function testNormalRegister() {
            const resultsDiv = document.getElementById('apiTestResults');
            const randomId = Date.now();
            
            try {
                const response = await fetch('/api/auth/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: `test${randomId}@example.com`,
                        username: `test${randomId}`,
                        password: 'password123'
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    let html = '<div class="success">âœ… æ­£å¸¸æ³¨å†Œæµ‹è¯•é€šè¿‡</div>';
                    html += '<pre>å“åº”æ•°æ®: ' + JSON.stringify(data, null, 2) + '</pre>';
                    resultsDiv.innerHTML = html;
                    updateStepStatus('step4', 'completed');
                } else {
                    resultsDiv.innerHTML = `<div class="error">âŒ æ­£å¸¸æ³¨å†Œæµ‹è¯•å¤±è´¥: ${data.error}</div>`;
                    updateStepStatus('step4', 'error');
                }
            } catch (error) {
                resultsDiv.innerHTML = `<div class="error">âŒ æ³¨å†Œæµ‹è¯•å¼‚å¸¸: ${error.message}</div>`;
                updateStepStatus('step4', 'error');
            }
        }
        
        // æµ‹è¯•é”™è¯¯åœºæ™¯
        async function testErrorCases() {
            const resultsDiv = document.getElementById('apiTestResults');
            let results = [];
            
            const tests = [
                { name: 'ç©ºå­—æ®µæµ‹è¯•', data: { email: '', username: 'test', password: 'password123' } },
                { name: 'æ— æ•ˆé‚®ç®±æµ‹è¯•', data: { email: 'invalid-email', username: 'test', password: 'password123' } },
                { name: 'å¯†ç å¤ªçŸ­æµ‹è¯•', data: { email: 'test@example.com', username: 'test', password: '123' } }
            ];
            
            for (const test of tests) {
                try {
                    const response = await fetch('/api/auth/register', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(test.data)
                    });
                    
                    const data = await response.json();
                    results.push(`${test.name}: ${response.ok ? 'âŒ åº”è¯¥å¤±è´¥ä½†æˆåŠŸäº†' : 'âœ… æ­£ç¡®è¿”å›é”™è¯¯'}`);
                } catch (error) {
                    results.push(`${test.name}: âŒ è¯·æ±‚å¤±è´¥ - ${error.message}`);
                }
            }
            
            resultsDiv.innerHTML = '<div class="info">ğŸ“‹ é”™è¯¯åœºæ™¯æµ‹è¯•ç»“æœ:</div><ul>' + 
                results.map(r => `<li>${r}</li>`).join('') + '</ul>';
        }
        
        // æµ‹è¯•é‡å¤é‚®ç®±
        async function testDuplicateEmail() {
            const resultsDiv = document.getElementById('apiTestResults');
            
            try {
                // å…ˆæ³¨å†Œä¸€ä¸ªç”¨æˆ·
                await fetch('/api/auth/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: 'duplicate@example.com',
                        username: 'duplicateuser',
                        password: 'password123'
                    })
                });
                
                // å†æ¬¡å°è¯•æ³¨å†Œç›¸åŒé‚®ç®±
                const response = await fetch('/api/auth/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: 'duplicate@example.com',
                        username: 'newuser',
                        password: 'password123'
                    })
                });
                
                const data = await response.json();
                
                if (!response.ok && data.error === 'é‚®ç®±å·²å­˜åœ¨') {
                    resultsDiv.innerHTML = '<div class="success">âœ… é‡å¤é‚®ç®±æ£€æµ‹æ­£å¸¸</div>';
                } else {
                    resultsDiv.innerHTML = `<div class="error">âŒ é‡å¤é‚®ç®±æ£€æµ‹å¼‚å¸¸: ${JSON.stringify(data)}</div>`;
                }
            } catch (error) {
                resultsDiv.innerHTML = `<div class="error">âŒ é‡å¤é‚®ç®±æµ‹è¯•å¼‚å¸¸: ${error.message}</div>`;
            }
        }
        
        // æµ‹è¯•Tokenç”Ÿæˆ
        async function testTokenGeneration() {
            const resultsDiv = document.getElementById('apiTestResults');
            
            try {
                const response = await fetch('/api/auth/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: `token${Date.now()}@example.com`,
                        username: `token${Date.now()}`,
                        password: 'password123'
                    })
                });
                
                const data = await response.json();
                
                if (response.ok && data.token && data.token.length > 50) {
                    resultsDiv.innerHTML = '<div class="success">âœ… Tokenç”Ÿæˆæ­£å¸¸</div>';
                } else {
                    resultsDiv.innerHTML = `<div class="error">âŒ Tokenç”Ÿæˆå¼‚å¸¸</div>`;
                }
            } catch (error) {
                resultsDiv.innerHTML = `<div class="error">âŒ Tokenæµ‹è¯•å¼‚å¸¸: ${error.message}</div>`;
            }
        }
        
        // æ¨¡æ‹Ÿå‰ç«¯æ³¨å†Œ
        async function simulateFrontendRegister() {
            const resultsDiv = document.getElementById('frontendTestResults');
            const email = document.getElementById('testEmail').value;
            const username = document.getElementById('testUsername').value;
            const password = document.getElementById('testPassword').value;
            
            if (!email || !username || !password) {
                resultsDiv.innerHTML = '<div class="error">âŒ è¯·å¡«å†™æ‰€æœ‰å­—æ®µ</div>';
                return;
            }
            
            resultsDiv.innerHTML = '<div class="info">ğŸ”„ æ­£åœ¨æ¨¡æ‹Ÿå‰ç«¯æ³¨å†Œ...</div>';
            
            try {
                // æ¨¡æ‹Ÿæµè§ˆå™¨çš„å®Œæ•´è¯·æ±‚
                const response = await fetch('/api/auth/register', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json',
                        'User-Agent': navigator.userAgent,
                        'Origin': window.location.origin,
                        'Referer': window.location.href
                    },
                    body: JSON.stringify({
                        email: email.trim(),
                        username: username.trim(),
                        password: password
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    // æ¨¡æ‹Ÿä¿å­˜åˆ°localStorage
                    try {
                        localStorage.setItem('token', data.token);
                        localStorage.setItem('user', JSON.stringify(data.user));
                    } catch (e) {
                        console.warn('localStorageä¿å­˜å¤±è´¥:', e);
                    }
                    
                    let html = '<div class="success">ğŸ‰ å‰ç«¯æ¨¡æ‹Ÿæ³¨å†ŒæˆåŠŸ!</div>';
                    html += '<pre>' + JSON.stringify(data, null, 2) + '</pre>';
                    resultsDiv.innerHTML = html;
                    updateStepStatus('step5', 'completed');
                } else {
                    let html = `<div class="error">âŒ å‰ç«¯æ¨¡æ‹Ÿæ³¨å†Œå¤±è´¥: ${data.error}</div>`;
                    if (data.details) {
                        html += `<div class="warning">è¯¦ç»†ä¿¡æ¯: ${data.details}</div>`;
                    }
                    html += '<pre>' + JSON.stringify(data, null, 2) + '</pre>';
                    resultsDiv.innerHTML = html;
                }
                
            } catch (error) {
                resultsDiv.innerHTML = `<div class="error">âŒ å‰ç«¯æ¨¡æ‹Ÿå¼‚å¸¸: ${error.message}</div>`;
            }
        }
        
        // è¿è¡Œå®Œæ•´è¯Šæ–­
        async function runFullDiagnosis() {
            const resultsDiv = document.getElementById('diagnosisResults');
            resultsDiv.innerHTML = '<div class="info">ğŸ”„ æ­£åœ¨è¿è¡Œå®Œæ•´è¯Šæ–­...</div>';
            
            // é‡ç½®æ‰€æœ‰æ­¥éª¤çŠ¶æ€
            for (let i = 1; i <= 5; i++) {
                updateStepStatus(`step${i}`, '');
            }
            
            try {
                // æ­¥éª¤1: ç³»ç»ŸçŠ¶æ€
                await checkSystemStatus();
                
                // æ­¥éª¤2-3: APIæµ‹è¯•
                await testNormalRegister();
                
                // æ­¥éª¤4: å‰ç«¯æ¨¡æ‹Ÿ
                await simulateFrontendRegister();
                
                resultsDiv.innerHTML = '<div class="success">ğŸ‰ å®Œæ•´è¯Šæ–­å®Œæˆï¼è¯·æŸ¥çœ‹ä¸Šè¿°å„é¡¹æµ‹è¯•ç»“æœã€‚</div>';
                
            } catch (error) {
                resultsDiv.innerHTML = `<div class="error">âŒ è¯Šæ–­è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯: ${error.message}</div>`;
            }
        }
        
        // æ›´æ–°æ­¥éª¤çŠ¶æ€
        function updateStepStatus(stepId, status) {
            const step = document.getElementById(stepId);
            step.className = 'step ' + status;
        }
        
        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨è¿è¡Œç³»ç»Ÿæ£€æŸ¥
        window.addEventListener('load', () => {
            checkSystemStatus();
        });
    </script>
</body>
</html>